<!DOCTYPE html>
<html lang="ca">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>Panda Royale ‚Äì Score</title>
<style>
  :root{
    --bg:#0f1013; --panel:#15171c; --ink:#f5f7fb; --muted:#b6bdc9; --grid:#262a33; --shadow:#0008;
    --y:#fde047; --y-ink:#3b2f00; --p:#c084fc; --p-ink:#2a0a4a; --b:#60a5fa; --b-ink:#0b2a59;
    --r:#f87171; --r-ink:#4c0a0a; --g:#34d399; --g-ink:#0b3b2a; --c:#e5e7eb; --c-ink:#1f2937; --pk:#f9a8d4; --pk-ink:#4f0f2f;
  }
  *{box-sizing:border-box; -webkit-tap-highlight-color:transparent}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.3 system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:12px}
  .sheet{background:linear-gradient(180deg,#1b1e24, #14171c);border:1px solid #0b0c10;border-radius:16px;box-shadow:0 18px 72px var(--shadow);padding:14px}
  header{text-align:center;margin:4px 0 12px}
  header h1{margin:0;font-weight:900;font-size:40px;letter-spacing:.06em}
  header h1 span{font-weight:900}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;justify-content:space-between;align-items:center;margin:8px 0}
  .btn,select{background:#0e1117;color:var(--ink);border:1px solid #2d3340;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn:hover{border-color:#3a4358}
  .names{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .pname{background:#0e1117;color:var(--ink);border:1px solid #2d3340;border-radius:10px;padding:8px 10px;font-weight:700;width:180px;max-width:44vw}
  .tabs{display:flex;gap:6px;overflow:auto;margin-bottom:8px;border-bottom:1px solid #20232b;padding-bottom:4px}
  .tab{padding:6px 10px;border:1px solid #2e3340;border-radius:999px;background:#0f1219;font-weight:800;cursor:pointer;white-space:nowrap}
  .tab.active{background:#1b2130;border-color:#3a4358;box-shadow:inset 0 0 0 2px #ffffff10}
  .board{border:1px solid var(--grid);border-radius:12px;overflow-x:auto;-webkit-overflow-scrolling: touch;background:#0e1015}
  table{border-collapse:collapse;min-width:800px;width:100%;font-size:14px}
  th,td{border:1px solid var(--grid);padding:6px;text-align:center;background:#141820}
  th.round,td.round{width:54px;font-weight:900;background:#10131a}
  th.block{font-size:16px;font-weight:900;background:#0b0e14}
  input[type="number"]{width:78px;background:#0a0d12;color:var(--ink);border:1px solid #2a2f3b;border-radius:8px;padding:8px;text-align:center;font-weight:700}
  .row-total{font-weight:900;background:#0d1016}
  tfoot td{background:#0c0f15;font-weight:900}
  .grand{font-size:18px}
  .color{padding:.1em .4em;border-radius:.4em;font-weight:900}
  .y{background:var(--y);color:var(--y-ink)} .p{background:var(--p);color:var(--p-ink)}
  .b{background:var(--b);color:var(--b-ink)} .r{background:var(--r);color:var(--r-ink)}
  .g{background:var(--g);color:var(--g-ink)} .c{background:var(--c);color:var(--c-ink)}
  .pk{background:var(--pk);color:var(--pk-ink)}
  .glit{font-size:12px;color:#cfd5e1;display:flex;gap:6px;justify-content:center;align-items:center}
  @media (max-width:720px){
    header h1{font-size:34px}
    input[type="number"]{width:72px}
  }
</style>
</head>
<body>
<div class="sheet" id="app">
  <header><h1>PANDA <span>ROYAL</span></h1></header>

  <div class="toolbar">
    <div>
      <label id="lblPlayers">üë•</label>
      <select id="numPlayers"><option>2</option><option>3</option><option>4</option><option>5</option><option>6</option></select>
      <button class="btn" id="startBtn">‚ôªÔ∏è</button>
    </div>
    <div>
      <select id="lang"></select>
      <button class="btn" id="exportBtn">üì§</button>
      <button class="btn" id="importBtn">üì•</button>
      <button class="btn" id="clearBtn">üÜï</button>
    </div>
  </div>

  <div class="names" id="nameArea"></div>
  <div class="tabs" id="tabs"></div>
  <div class="board"><table id="scoreTable" aria-label="Full de puntuaci√≥"></table></div>
</div>

<script>
/* ==== I18N ==== */
const I18N={
  en:{players:"Players",clear:"üÜï Clear",export:"üì§ Export",import:"üì• Import",round:"Round",total:"TOTAL",yellow:"Yellow",purple:"Purple√ó2",blue:"Blue",glitter:"‚ú®√ó2",red:"Red  Œ£√ó#",green:"Green",white:"White",pink:"Pink",tabTotal:"üèÜ Total",namePH:"Player"},
  ca:{players:"Jugadors",clear:"üÜï Neteja",export:"üì§ Exporta",import:"üì• Importa",round:"Ronda",total:"TOTAL",yellow:"Groc",purple:"Porpra√ó2",blue:"Blau",glitter:"‚ú®√ó2",red:"Vermell  Œ£√ó#",green:"Verd",white:"Blanc",pink:"Rosa",tabTotal:"üèÜ Total",namePH:"Jugador"},
  es:{players:"Jugadores",clear:"üÜï Limpiar",export:"üì§ Exportar",import:"üì• Importar",round:"Ronda",total:"TOTAL",yellow:"Amarillo",purple:"Morado√ó2",blue:"Azul",glitter:"‚ú®√ó2",red:"Rojo  Œ£√ó#",green:"Verde",white:"Blanco",pink:"Rosa",tabTotal:"üèÜ Total",namePH:"Jugador"},
  gl:{players:"Xogadores",clear:"üÜï Limpar",export:"üì§ Exportar",import:"üì• Importar",round:"Rolda",total:"TOTAL",yellow:"Amarelo",purple:"Morado√ó2",blue:"Azul",glitter:"‚ú®√ó2",red:"Vermello  Œ£√ó#",green:"Verde",white:"Branco",pink:"Rosa",tabTotal:"üèÜ Total",namePH:"Xogador"},
  eu:{players:"Jokalariak",clear:"üÜï Garbitu",export:"üì§ Exportatu",import:"üì• Inportatu",round:"Txanda",total:"GUZTIRA",yellow:"Horia",purple:"Morea√ó2",blue:"Urdina",glitter:"‚ú®√ó2",red:"Gorria  Œ£√ó#",green:"Berdea",white:"Zuria",pink:"Arrosa",tabTotal:"üèÜ Guztira",namePH:"Jokalaria"},
  fr:{players:"Joueurs",clear:"üÜï Effacer",export:"üì§ Exporter",import:"üì• Importer",round:"Manche",total:"TOTAL",yellow:"Jaune",purple:"Violet√ó2",blue:"Bleu",glitter:"‚ú®√ó2",red:"Rouge  Œ£√ó#",green:"Vert",white:"Blanc",pink:"Rose",tabTotal:"üèÜ Total",namePH:"Joueur"}
};
const flags={en:"üá¨üáß",ca:"üá¶üá©",es:"üá™üá∏",gl:"üá¨üá¶",eu:"üè¥",fr:"üá´üá∑"}; // icones/flags simb√≤liques

/* ==== Const / Storage ==== */
const ROUNDS=10;
const KEY='panda-royale-multi-v2';

/* ==== Model ==== */
function blankPlayer(name){
  return { name,
    rows:Array.from({length:ROUNDS},()=>({y:'',p:'',b:'',glitter:false,rSum:'',rCount:'',g:'',c:'',pk:'',_row:0})),
    total:0
  };
}
function newState(n, lang){
  return { active:0, numPlayers:n, lang:lang,
    players:Array.from({length:n},(_,i)=>blankPlayer(`${I18N[lang]?.namePH||'Player'} ${i+1}`))
  };
}
function toInt(v){const n=parseInt(v,10);return Number.isFinite(n)?n:0;}
function calcRow(r){
  const y=toInt(r.y), p=toInt(r.p)*2, b=toInt(r.b)*(r.glitter?2:1);
  const rScore=toInt(r.rSum)*toInt(r.rCount), g=toInt(r.g), c=toInt(r.c), pk=toInt(r.pk);
  return r._row=y+p+b+rScore+g+c+pk;
}
function calcPlayer(p){p.total=p.rows.reduce((a,r)=>a+calcRow(r),0);return p.total;}

/* ==== Load first, then language ==== */
let loaded;
try{ loaded=JSON.parse(localStorage.getItem(KEY)||'null'); }catch(e){ loaded=null; }
let curLang = (loaded && loaded.lang && I18N[loaded.lang]) ? loaded.lang : 'ca';
let state = loaded || newState(2, curLang);

/* ==== DOM refs ==== */
const tabs=document.getElementById('tabs');
const table=document.getElementById('scoreTable');
const nameArea=document.getElementById('nameArea');
const selPlayers=document.getElementById('numPlayers');
const btnStart=document.getElementById('startBtn');
const btnClear=document.getElementById('clearBtn');
const btnExport=document.getElementById('exportBtn');
const btnImport=document.getElementById('importBtn');
const selLang=document.getElementById('lang');
const lblPlayers=document.getElementById('lblPlayers');

/* ==== I18N apply ==== */
function applyLang(){
  // selector d‚Äôidioma
  selLang.innerHTML = Object.keys(I18N)
    .map(k=>`<option value="${k}" ${k===curLang?'selected':''}>${flags[k]||''} ${k.toUpperCase()}</option>`).join('');
  const t=I18N[curLang];
  lblPlayers.textContent = `üë• ${t.players}`;
  btnClear.textContent = t.clear; btnExport.textContent=t.export; btnImport.textContent=t.import;
  selPlayers.value = state.numPlayers;
}
selLang.onchange=(e)=>{curLang=e.target.value; applyLang(); buildNames(); buildTabs(); buildTable(); save();};

/* ==== Builders ==== */
function buildNames(){
  nameArea.innerHTML='';
  state.players.forEach((p,i)=>{
    const inp=document.createElement('input');
    inp.className='pname';
    inp.placeholder=`${I18N[curLang].namePH} ${i+1}`;
    inp.value=p.name||inp.placeholder;
    inp.addEventListener('input',()=>{
      p.name = inp.value.trim() || inp.placeholder;
      // refresca pestanyes i cap√ßalera si cal
      buildTabs();
      if(state.active===i) buildTable();
      save();
    }, {passive:true});
    nameArea.appendChild(inp);
  });
}
function buildTabs(){
  tabs.innerHTML='';
  state.players.forEach((p,i)=>{
    const b=document.createElement('button');
    b.className='tab'+(state.active===i?' active':'');
    b.textContent=`${p.name} (${p.total||0})`;
    b.addEventListener('click',()=>{state.active=i; buildTabs(); buildTable(); save();});
    tabs.appendChild(b);
  });
  const total=document.createElement('button');
  total.className='tab'+(state.active==='all'?' active':'');
  total.textContent=I18N[curLang].tabTotal;
  total.addEventListener('click',()=>{state.active='all'; buildTabs(); buildTable(); save();});
  tabs.appendChild(total);
}

function headCell(label, cls, sub=''){
  return `<th><div class="color ${cls}">${label}</div>${sub?`<div class="tiny" style="color:${getComputedStyle(document.body).getPropertyValue('--muted')};font-size:12px"></div>`:''}</th>`;
}

function numInput(p,r,k,val){
  return `<input type="number" min="0" inputmode="numeric" data-p="${p}" data-r="${r}" data-k="${k}" value="${val??''}" placeholder="0">`;
}

function buildTable(){
  const t = I18N[curLang];
  if(state.active==='all'){
    // R√†nquing
    const sorted = [...state.players].sort((a,b)=>b.total-a.total);
    let h=`<thead><tr><th>ü•á</th><th>${t.players}</th><th>${t.total}</th></tr></thead><tbody>`;
    sorted.forEach((p,idx)=>{
      const medal = idx===0?'ü•á':idx===1?'ü•à':idx===2?'ü•â':'';
      h += `<tr><td>${medal}</td><td>${p.name}</td><td>${p.total}</td></tr>`;
    });
    h+='</tbody>';
    table.innerHTML=h;
    return;
  }

  const i=state.active, pl=state.players[i];
  let h='<thead>';
  h += `<tr><th class="round">${t.round}</th><th class="block" colspan="8">${pl.name} (${pl.total||0})</th></tr>`;
  h += '<tr><th></th>';
  h += `<th>${t.yellow}</th><th>${t.purple}</th><th>${t.blue}</th><th>${t.red}</th><th>${t.green}</th><th>${t.white}</th><th>${t.pink}</th><th>${t.total}</th>`;
  h += '</tr></thead><tbody>';

  for(let r=0;r<ROUNDS;r++){
    const row=pl.rows[r];
    h += `<tr><td class="round">${r+1}</td>`;
    h += `<td>${numInput(i,r,'y',row.y)}</td>`;
    h += `<td>${numInput(i,r,'p',row.p)}</td>`;
    h += `<td>${numInput(i,r,'b',row.b)}<div class="glit"><input type="checkbox" data-p="${i}" data-r="${r}" data-k="glitter" ${row.glitter?'checked':''}> ${t.glitter}</div></td>`;
    h += `<td><div style="display:flex;gap:6px;justify-content:center"><input type="number" placeholder="Œ£" data-p="${i}" data-r="${r}" data-k="rSum" value="${row.rSum}"><input type="number" placeholder="#" data-p="${i}" data-r="${r}" data-k="rCount" value="${row.rCount}"></div></td>`;
    h += `<td>${numInput(i,r,'g',row.g)}</td>`;
    h += `<td>${numInput(i,r,'c',row.c)}</td>`;
    h += `<td>${numInput(i,r,'pk',row.pk)}</td>`;
    h += `<td class="row-total" data-p="${i}" data-r="${r}">${row._row||0}</td></tr>`;
  }

  h += `</tbody><tfoot><tr><td>${t.total}</td><td colspan="7"></td><td class="grand" data-p="${i}">${pl.total||0}</td></tr></tfoot>`;
  table.innerHTML=h;

  // esdeveniments
  table.querySelectorAll('input[type="number"]').forEach(inp=>{
    inp.addEventListener('input',onNum,{passive:true});
  });
  table.querySelectorAll('input[type="checkbox"][data-k="glitter"]').forEach(chk=>{
    chk.addEventListener('change',onChk,{passive:true});
  });
}

/* ==== Handlers ==== */
function onNum(e){
  const {p,r,k} = e.target.dataset;
  state.players[+p].rows[+r][k] = e.target.value;
  recalc();
}
function onChk(e){
  const {p,r} = e.target.dataset;
  state.players[+p].rows[+r].glitter = e.target.checked;
  recalc();
}

/* ==== Recalc / Save ==== */
function recalc(){
  state.players.forEach(calcPlayer);
  buildTabs();
  buildTable();
  save();
}
function save(){
  state.lang = curLang;
  try{ localStorage.setItem(KEY, JSON.stringify(state)); }catch(e){}
}

/* ==== Buttons ==== */
btnStart.onclick=()=>{
  const n=parseInt(selPlayers.value,10);
  // conserva noms si redueixes/amplies
  const old=state.players;
  const players = Array.from({length:n}, (_,i)=> old[i] ? old[i] : blankPlayer(`${I18N[curLang].namePH} ${i+1}`));
  state={active:0,numPlayers:n,players,lang:curLang};
  buildNames(); buildTabs(); buildTable(); save();
};
btnClear.onclick=()=>{
  if(!confirm('Reset?')) return;
  state=newState(state.numPlayers, curLang);
  buildNames(); buildTabs(); buildTable(); save();
};
btnExport.onclick=()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='panda-royale.json';
  document.body.appendChild(a); a.click(); a.remove();
};
btnImport.onclick=()=>{
  const i=document.createElement('input'); i.type='file'; i.accept='application/json';
  i.onchange=()=>{
    const f=i.files[0]; if(!f) return;
    const r=new FileReader();
    r.onload=()=>{ try{
      const data=JSON.parse(r.result);
      if(!data || !Array.isArray(data.players)) throw new Error('format');
      state=data;
      curLang = I18N[state.lang] ? state.lang : curLang;
      applyLang(); buildNames(); buildTabs(); buildTable(); save();
    }catch(err){ alert('Arxiu inv√†lid.'); } };
    r.readAsText(f);
  };
  i.click();
};

/* ==== First render ==== */
applyLang();
buildNames();
buildTabs();
buildTable();
</script>
</body>
</html>
